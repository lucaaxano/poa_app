# POA - Point of Accident
# Docker Compose for Production Deployment
# Version 1.0
#
# Usage:
# 1. Copy .env.production.example to .env and fill in values
# 2. Run: docker compose -f docker-compose.prod.yml up -d
# 3. Run migrations: docker compose -f docker-compose.prod.yml --profile migrate up migrate

version: '3.8'

services:
  # ===========================================
  # Frontend - Next.js
  # ===========================================
  web:
    build:
      context: .
      dockerfile: docker/web.prod.Dockerfile
      args:
        NEXT_PUBLIC_API_URL: https://api.poa-platform.de/api
        NEXT_PUBLIC_APP_URL: https://poa-platform.de
    container_name: poa-web
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      - NODE_ENV=production
      # PERFORMANCE FIX: Increased memory for stable operation
      # Next.js standalone needs more memory for SSR + serving static files
      - NODE_OPTIONS=--max-old-space-size=1024
    # Resource limits - increased for stable performance
    deploy:
      resources:
        limits:
          memory: 1536M
        reservations:
          memory: 512M
    depends_on:
      - api
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - poa-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.poa-web.rule=Host(`poa-platform.de`) || Host(`www.poa-platform.de`)"
      - "traefik.http.routers.poa-web.entrypoints=websecure"
      - "traefik.http.routers.poa-web.tls=true"
      - "traefik.http.routers.poa-web.tls.certresolver=letsencrypt"
      - "traefik.http.services.poa-web.loadbalancer.server.port=3000"
      # Health check for Traefik
      - "traefik.http.services.poa-web.loadbalancer.healthcheck.path=/api/health"
      - "traefik.http.services.poa-web.loadbalancer.healthcheck.interval=10s"
      - "traefik.http.services.poa-web.loadbalancer.healthcheck.timeout=5s"
      # Response buffering and forwarding
      - "traefik.http.services.poa-web.loadbalancer.responseforwarding.flushinterval=100ms"
      - "traefik.http.services.poa-web.loadbalancer.passhostheader=true"
      # HTTP to HTTPS redirect
      - "traefik.http.routers.poa-web-http.rule=Host(`poa-platform.de`) || Host(`www.poa-platform.de`)"
      - "traefik.http.routers.poa-web-http.entrypoints=web"
      - "traefik.http.routers.poa-web-http.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

  # ===========================================
  # Backend - NestJS API
  # ===========================================
  api:
    build:
      context: .
      dockerfile: docker/api.prod.Dockerfile
    container_name: poa-api
    restart: unless-stopped
    expose:
      - "4000"
    # CRITICAL: Memory limits to prevent crashes
    deploy:
      resources:
        limits:
          memory: 1024M
        reservations:
          memory: 256M
    environment:
      - NODE_ENV=production
      - PORT=4000
      # PERFORMANCE FIX: Reduced connection limit from 50 to 20
      # Too many connections can overwhelm the database
      - DATABASE_URL=postgresql://${DB_USER:-poa_admin}:${DB_PASSWORD}@db:5432/${DB_NAME:-poa_production}?connection_limit=20&pool_timeout=30&connect_timeout=15
      # CRITICAL: Node.js memory limit to prevent OOM crashes
      - NODE_OPTIONS=--max-old-space-size=768
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=15m
      - JWT_REFRESH_EXPIRES_IN=7d
      - STORAGE_ENDPOINT=http://storage:9000
      - STORAGE_ACCESS_KEY=${MINIO_ACCESS_KEY:-minioadmin}
      - STORAGE_SECRET_KEY=${MINIO_SECRET_KEY:-minioadmin}
      - STORAGE_BUCKET=poa-uploads
      - STORAGE_PUBLIC_URL=https://storage.poa-platform.de
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-smtp}
      - SMTP_HOST=${SMTP_HOST:-localhost}
      - SMTP_PORT=${SMTP_PORT:-1025}
      - RESEND_API_KEY=${RESEND_API_KEY:-}
      - EMAIL_FROM=${EMAIL_FROM:-noreply@poa-platform.de}
      - EMAIL_FROM_NAME=POA System
      - FRONTEND_URL=https://poa-platform.de
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
    depends_on:
      db:
        condition: service_healthy
      storage:
        condition: service_started
    networks:
      - poa-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.poa-api.rule=Host(`api.poa-platform.de`)"
      - "traefik.http.routers.poa-api.entrypoints=websecure"
      - "traefik.http.routers.poa-api.tls=true"
      - "traefik.http.routers.poa-api.tls.certresolver=letsencrypt"
      - "traefik.http.services.poa-api.loadbalancer.server.port=4000"
      # HTTP to HTTPS redirect
      - "traefik.http.routers.poa-api-http.rule=Host(`api.poa-platform.de`)"
      - "traefik.http.routers.poa-api-http.entrypoints=web"
      - "traefik.http.routers.poa-api-http.middlewares=redirect-to-https"
      # Timeout and connection configuration for long-running requests
      # Note: Actual timeout values are configured at Traefik entrypoint level
      - "traefik.http.services.poa-api.loadbalancer.responseforwarding.flushinterval=100ms"
      - "traefik.http.services.poa-api.loadbalancer.passhostheader=true"
      # Health check to ensure backend is ready before routing traffic
      - "traefik.http.services.poa-api.loadbalancer.healthcheck.path=/api/health"
      - "traefik.http.services.poa-api.loadbalancer.healthcheck.interval=10s"
      - "traefik.http.services.poa-api.loadbalancer.healthcheck.timeout=5s"
      # CORS Headers Middleware (for error responses when backend is unavailable)
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowmethods=GET,POST,PUT,PATCH,DELETE,OPTIONS"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowheaders=Content-Type,Authorization"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolalloworiginlist=https://poa-platform.de,https://www.poa-platform.de"
      - "traefik.http.middlewares.api-cors.headers.accesscontrolallowcredentials=true"
      - "traefik.http.routers.poa-api.middlewares=api-cors"

  # ===========================================
  # Database - PostgreSQL
  # ===========================================
  db:
    image: postgres:15-alpine
    container_name: poa-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${DB_USER:-poa_admin}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_DB=${DB_NAME:-poa_production}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-poa_admin} -d ${DB_NAME:-poa_production}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - poa-network
    # Database is NOT exposed externally for security
    # Access via SSH tunnel or adminer if needed

  # ===========================================
  # Object Storage - MinIO (S3-compatible)
  # ===========================================
  storage:
    image: minio/minio
    container_name: poa-storage
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ACCESS_KEY:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_SECRET_KEY:-minioadmin}
    volumes:
      - minio_data:/data
    networks:
      - poa-network
    labels:
      - "traefik.enable=true"
      # MinIO API (for file access)
      - "traefik.http.routers.poa-storage.rule=Host(`storage.poa-platform.de`)"
      - "traefik.http.routers.poa-storage.entrypoints=websecure"
      - "traefik.http.routers.poa-storage.tls=true"
      - "traefik.http.routers.poa-storage.tls.certresolver=letsencrypt"
      - "traefik.http.routers.poa-storage.service=poa-storage"
      - "traefik.http.services.poa-storage.loadbalancer.server.port=9000"

  # ===========================================
  # MinIO Setup - Creates bucket on startup
  # ===========================================
  storage-setup:
    image: minio/mc
    container_name: poa-storage-setup
    depends_on:
      - storage
    entrypoint: >
      /bin/sh -c "
      echo 'Waiting for MinIO to start...';
      sleep 15;
      echo 'Configuring MinIO...';
      mc alias set myminio http://storage:9000 ${MINIO_ACCESS_KEY:-minioadmin} ${MINIO_SECRET_KEY:-minioadmin};
      mc mb myminio/poa-uploads --ignore-existing;
      mc anonymous set download myminio/poa-uploads;
      echo 'MinIO bucket configured successfully!';
      exit 0;
      "
    networks:
      - poa-network

  # ===========================================
  # Database Migrations (run manually)
  # ===========================================
  migrate:
    build:
      context: .
      dockerfile: docker/api.prod.Dockerfile
    container_name: poa-migrate
    command: >
      sh -c "
        echo 'Running database migrations...';
        cd /app/packages/database &&
        npx prisma migrate deploy;
        echo 'Seeding database...';
        npx prisma db seed;
        echo 'Migration complete!';
      "
    environment:
      - DATABASE_URL=postgresql://${DB_USER:-poa_admin}:${DB_PASSWORD}@db:5432/${DB_NAME:-poa_production}
    depends_on:
      db:
        condition: service_healthy
    networks:
      - poa-network
    profiles:
      - migrate

# ===========================================
# Volumes (Persistent Data)
# ===========================================
volumes:
  postgres_data:
    name: poa-postgres-data-prod
  minio_data:
    name: poa-minio-data-prod

# ===========================================
# Networks
# ===========================================
networks:
  poa-network:
    name: poa-network-prod
    driver: bridge
